# 影响因子系统设计文档

> 版本: 2.0  
> 最后更新: 2026-01-05  
> 状态: 设计中

---

## 一、设计原则

### 1.1 理论基础要求

所有因子和权重设定必须遵循以下原则：
- **可验证性**：基于经典占星学文献或天文学数据
- **可解释性**：每个参数都有明确的占星学含义
- **可调整性**：支持运营后期调整，但调整范围有理论约束

### 1.2 核心架构

```
影响因子 → 维度分数 → 综合分数
         ↑           ↑
     正弦曲线      加权聚合
     生命周期
```

---

## 二、因子分级体系

### 2.1 时间级别分类

基于占星学周期理论，因子按照作用周期分为五级：

| 级别 | 周期范围 | 占星学依据 | 典型因子 |
|------|---------|-----------|---------|
| **年度级** | 1年以上 | 外行星行运、推运周期 | 土星回归(29.5年)、木星回归(12年)、天王星对冲(42年)、推运月相(27.3年) |
| **月度级** | 1-12个月 | 内行星行运、朔望周期 | 太阳换座(30天)、金星周期(225天)、火星周期(687天)、月相周期(29.5天) |
| **周度级** | 1-4周 | 逆行周期、月亮节点 | 水星逆行(约21天)、月亮南北交进退 |
| **日度级** | 1-7天 | 月亮行运、行星日 | 月亮换座(2.5天)、行星日轮换 |
| **小时级** | 1-24小时 | 行星时、月亮空亡 | 行星时(约1小时)、月亮空亡(数小时) |

### 2.2 可见性规则

遵循"大包含小"原则：
- 年度级因子：在年/月/周/日/时视图中均可见
- 月度级因子：在月/周/日/时视图中可见
- 周度级因子：在周/日/时视图中可见
- 日度级因子：在日/时视图中可见
- 小时级因子：仅在时视图中可见

---

## 三、维度理论基础

### 3.1 五维度与宫位对应

基于传统占星学十二宫位系统：

| 维度 | 对应宫位 | 占星学含义 | 主管行星 |
|------|---------|-----------|---------|
| **事业 (Career)** | 1, 6, 10宫 | 自我实现、工作服务、社会地位 | 土星、太阳、火星 |
| **关系 (Relationship)** | 3, 5, 7, 11宫 | 沟通、恋爱、婚姻、社交 | 金星、月亮、水星 |
| **健康 (Health)** | 1, 6, 8, 12宫 | 身体活力、疾病、转化、隐疾 | 火星、月亮、冥王星 |
| **财务 (Finance)** | 2, 8宫 | 个人资源、共享资源 | 金星、木星、冥王星 |
| **灵性 (Spiritual)** | 9, 12宫 | 高等学习、灵性追求、潜意识 | 木星、海王星、天王星 |

### 3.2 行星-维度影响矩阵

基于行星的本质象征意义（参考 Liz Greene、Stephen Arroyo 等现代占星学文献）：

```
行星      事业   关系   健康   财务   灵性   理论依据
──────────────────────────────────────────────────────
太阳      0.35   0.15   0.25   0.10   0.15   自我实现、生命力核心
月亮      0.10   0.30   0.30   0.10   0.20   情感需求、身体节律
水星      0.30   0.25   0.10   0.25   0.10   思维沟通、商业交易
金星      0.10   0.45   0.10   0.25   0.10   爱与美、价值观
火星      0.30   0.10   0.40   0.10   0.10   行动力、身体能量
木星      0.25   0.15   0.10   0.30   0.20   扩张、机遇、信仰
土星      0.40   0.10   0.20   0.20   0.10   责任、结构、限制
天王星    0.20   0.10   0.10   0.10   0.50   突破、觉醒、创新
海王星    0.10   0.20   0.10   0.10   0.50   灵感、幻想、灵性
冥王星    0.20   0.15   0.20   0.25   0.20   转化、权力、资源
北交点    0.15   0.20   0.10   0.10   0.45   命运方向、灵魂成长
凯龙      0.10   0.20   0.30   0.05   0.35   伤痛与疗愈
```

### 3.3 维度权重

基于生活领域的普遍重要性：

| 维度 | 权重 | 理论依据 |
|------|------|---------|
| 事业 | 0.25 | 10宫（天顶）是人生目标的最高表达 |
| 关系 | 0.20 | 7宫是1宫的对宫，人际关系是人生镜子 |
| 健康 | 0.20 | 6宫+1宫，身体是载体 |
| 财务 | 0.20 | 2宫+8宫，物质基础 |
| 灵性 | 0.15 | 9宫+12宫，精神层面 |

---

## 四、本命盘基础分计算

### 4.1 理论依据

每个人的本命盘决定了其在各维度的"先天禀赋"。基于：
- 行星落入的宫位
- 行星的尊贵度
- 宫主星状态
- 相位格局

### 4.2 计算公式

```
维度基础分 = 50 + Σ(宫位行星贡献) + Σ(宫主星状态) + 格局加成
```

#### 4.2.1 宫位行星贡献

当行星落入与维度相关的宫位时：

```go
func calculatePlanetInHouseContribution(planet PlanetID, house int, dignity Dignity) float64 {
    // 基础分值：行星在宫位的自然表达
    baseValue := getPlanetHouseNaturalValue(planet, house)
    
    // 尊贵度修正
    dignityMultiplier := getDignityMultiplier(dignity)
    // 入庙: 1.5, 旺相: 1.3, 正常: 1.0, 落陷: 0.7, 失势: 0.5
    
    return baseValue * dignityMultiplier
}
```

#### 4.2.2 宫主星状态

```go
func calculateHouseRulerContribution(houseRuler PlanetID, rulerSign ZodiacID, rulerHouse int) float64 {
    // 宫主星的尊贵度
    dignity := GetDignity(houseRuler, rulerSign)
    dignityScore := GetDignityScore(dignity) // +3 ~ -3
    
    // 宫主星落入的宫位是否有利
    houseNature := getHouseNature(rulerHouse)
    // 1,4,7,10宫: 有力 +2
    // 2,5,9,11宫: 中性 +1
    // 3,6,8,12宫: 困难 -1
    
    return dignityScore + houseNature
}
```

### 4.3 基础分范围

经过上述计算，基础分范围约为 35-65：
- 某维度非常强的命盘：60-65
- 某维度普通的命盘：45-55
- 某维度较弱的命盘：35-40

---

## 五、因子生命周期

### 5.1 正弦曲线强度函数

基于行运相位的"入相-精确-离相"过程：

```go
// 正弦曲线：模拟因子从开始到结束的强度变化
// 
//        1.0 ┤     ╭───╮
//            │    ╱     ╲
//        0.5 ┤   ╱       ╲
//            │  ╱         ╲
//        0.0 ┼─╱───────────╲──
//            开始   峰值   结束

func calculateFactorStrength(startTime, endTime, currentTime time.Time) float64 {
    duration := endTime.Sub(startTime).Seconds()
    elapsed := currentTime.Sub(startTime).Seconds()
    
    if elapsed < 0 || elapsed > duration {
        return 0.0
    }
    
    // sin(π × progress) 确保：
    // - progress=0 时 strength=0
    // - progress=0.5 时 strength=1 (峰值)
    // - progress=1 时 strength=0
    progress := elapsed / duration
    strength := math.Sin(math.Pi * progress)
    
    return strength
}
```

### 5.2 因子作用时长

基于天文周期确定各类因子的作用时长：

| 因子类型 | 作用时长 | 天文依据 |
|---------|---------|---------|
| 太阳换座 | 30天 | 太阳每月移动约30° |
| 月亮换座 | 2.5天 | 月亮每月绕行360° |
| 水星逆行 | 21天 | 水星逆行周期 |
| 金星逆行 | 42天 | 金星逆行周期 |
| 火星逆行 | 72天 | 火星逆行周期 |
| 木星换座 | 365天 | 木星绕日周期12年 |
| 土星换座 | 2.5年 | 土星绕日周期29.5年 |
| 行星相位 | 容许度决定 | 1°/天 ≈ 容许度天数 |

---

## 六、因子值计算

### 6.1 尊贵度因子

基于托勒密尊贵度系统：

| 尊贵度 | 分值 | 占星学含义 |
|--------|------|-----------|
| 入庙 (Domicile) | +3.0 | 行星在自己主管的星座，力量最强 |
| 旺相 (Exaltation) | +2.0 | 行星在提升其能量的星座 |
| 中性 (Peregrine) | 0.0 | 行星无特殊尊贵或落陷 |
| 落陷 (Detriment) | -2.0 | 行星在对宫星座，表达受阻 |
| 失势 (Fall) | -3.0 | 行星在旺相对宫，能量最弱 |

### 6.2 逆行因子

基于逆行的占星学含义（内省、延迟、回顾）：

| 行星 | 逆行分值 | 理论依据 |
|------|---------|---------|
| 水星 | -3.0 | 主管沟通交流，逆行影响最直接 |
| 金星 | -2.5 | 主管关系价值，逆行需回顾情感 |
| 火星 | -2.5 | 主管行动力，逆行行动受阻 |
| 木星 | -1.5 | 外行星，逆行常态化 |
| 土星 | -1.5 | 外行星，逆行常态化 |
| 天王星 | -1.0 | 超外行星，逆行近半年 |
| 海王星 | -1.0 | 超外行星，逆行近半年 |
| 冥王星 | -1.0 | 超外行星，逆行近半年 |

### 6.3 相位因子

基于托勒密相位系统：

| 相位 | 角度 | 基础分值 | 性质 | 占星学含义 |
|------|------|---------|------|-----------|
| 合相 | 0° | ±10 | 视行星 | 能量融合，新周期开始 |
| 六分 | 60° | +6 | 和谐 | 机会、配合、流动 |
| 四分 | 90° | -7 | 紧张 | 挑战、行动、冲突 |
| 三分 | 120° | +8 | 和谐 | 天赋、顺流、祝福 |
| 对分 | 180° | ±8 | 视行星 | 觉知、对立、整合 |

**相位强度计算：**

```go
// 容许度衰减：越精确越强
strength := 1.0 - (orb / maxOrb)

// 入相增强：正在形成的相位影响更强
if applying {
    strength *= 1.2
} else {
    strength *= 0.8
}
```

### 6.4 月相因子

基于月亮周期的八个阶段：

| 月相 | 角度范围 | 分值 | 占星学含义 |
|------|---------|------|-----------|
| 新月 | 0-45° | +1.0 | 播种期，设立意图 |
| 上弦月 | 45-90° | +1.5 | 生长期，采取行动 |
| 上弦 | 90-135° | 0.0 | 危机点，调整方向 |
| 盈凸月 | 135-180° | +1.0 | 完善期，准备收获 |
| 满月 | 180-225° | +2.0 | 顶峰期，收获展现 |
| 亏凸月 | 225-270° | +0.5 | 分享期，传播成果 |
| 下弦 | 270-315° | -1.0 | 释放期，放手 |
| 残月 | 315-360° | -0.5 | 休眠期，反思 |

---

## 七、分数聚合与标准化

### 7.1 小时分 → 日分聚合

采用**特征提取法**：

```go
type DayScoreFeatures struct {
    Average   float64 // 24小时平均值
    Max       float64 // 最高值
    Min       float64 // 最低值
    Trend     float64 // 趋势斜率（正=上升，负=下降）
    Stability float64 // 稳定性（标准差的倒数）
}

func aggregateHourlyToDaily(hourlyScores []float64) float64 {
    features := extractFeatures(hourlyScores)
    
    // 加权组合
    // 平均值占主导，但极值和趋势有修正作用
    dailyScore := features.Average * 0.6 +
                  features.Max * 0.15 +
                  features.Min * 0.10 +
                  (features.Average + features.Trend*5) * 0.15
    
    return normalizeScore(dailyScore)
}
```

### 7.2 标准化函数

确保所有层级分数在 0-100 范围，使用改进的 tanh 压缩：

```go
func normalizeScore(raw float64) float64 {
    // 假设原始分数范围约为 -50 ~ +150
    // 使用 tanh 将其压缩到 0-100
    
    // 偏移到以 50 为中心
    centered := raw - 50
    
    // 缩放因子：控制曲线陡峭程度
    // scale=25 时，±50 的原始分数 → 约 25-75 的输出
    scale := 25.0
    
    // tanh 压缩
    compressed := math.Tanh(centered / scale)
    
    // 映射到 0-100
    normalized := 50 + 50*compressed
    
    // 确保边界
    return math.Max(0, math.Min(100, normalized))
}
```

### 7.3 显示抖动（仅视觉层）

```go
func applyVisualJitter(score float64, seed int64) float64 {
    // 使用确定性随机数（相同seed产生相同抖动）
    r := rand.New(rand.NewSource(seed))
    
    // 抖动范围：±0.5
    jitter := (r.Float64() - 0.5) * 1.0
    
    // 应用抖动
    jittered := score + jitter
    
    // 保留4位小数
    return math.Round(jittered*10000) / 10000
}
```

---

## 八、自定义因子格式

### 8.1 格式规范

```
操作类型 = (公式, 持续时长, 开始时间)

示例：
AddScore = (2*healthScore, 2.5, 202501173012)

解析：
- 操作类型: AddScore（加法叠加）
- 公式: 2*healthScore（健康分×2）
- 持续时长: 2.5 小时
- 开始时间: 2025-01-17 30:12 → 需修正格式
```

### 8.2 时间格式修正

采用 **YYYYMMDDHHmm** 格式：

```
202501171230 = 2025年01月17日 12:30
```

### 8.3 支持的操作类型

| 操作 | 语法 | 含义 |
|------|------|------|
| AddScore | `(+N, 时长, 时间)` | 加分 |
| SubScore | `(-N, 时长, 时间)` | 减分 |
| MulScore | `(*N, 时长, 时间)` | 乘法 |
| SetScore | `(=N, 时长, 时间)` | 强制设定 |

---

## 九、API 接口设计

### 9.1 因子权重配置 API

```
PUT /api/admin/factor-weights
{
    "dignity": 1.0,
    "retrograde": 1.0,
    "aspectPhase": 0.8,
    "lunarPhase": 0.7,
    "planetaryHour": 0.3,
    "profectionLord": 1.0
}
```

### 9.2 维度权重配置 API

```
PUT /api/admin/dimension-weights
{
    "career": 0.25,
    "relationship": 0.20,
    "health": 0.20,
    "finance": 0.20,
    "spiritual": 0.15
}
```

### 9.3 自定义因子 API

```
POST /api/admin/custom-factors
{
    "userId": "user123",
    "factors": [
        {
            "type": "AddScore",
            "dimension": "health",
            "value": 10,
            "duration": 2.5,
            "startTime": "202501171230"
        }
    ]
}
```

---

## 十、实施计划

### Phase 1: 核心重构
1. 重新设计 InfluenceFactor 结构
2. 实现因子生命周期（正弦曲线）
3. 实现因子-维度映射

### Phase 2: 分数体系
1. 实现本命盘基础分计算
2. 实现时间层级聚合
3. 实现标准化函数

### Phase 3: 运营接口
1. 实现权重配置 API
2. 实现自定义因子 API
3. 实现因子查看/调试界面

---

## 附录：参考文献

1. Ptolemy, *Tetrabiblos* - 尊贵度系统原始定义
2. William Lilly, *Christian Astrology* (1647) - 传统相位与尊贵度
3. Robert Hand, *Planets in Transit* - 现代行运解读
4. Stephen Arroyo, *Astrology, Psychology, and the Four Elements* - 行星心理学
5. Liz Greene, *Saturn: A New Look at an Old Devil* - 土星周期
6. Dane Rudhyar, *The Lunation Cycle* - 月相八阶段


